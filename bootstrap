#!/bin/bash

ME=`whoami`
DOTFILES=~/.dotfiles
REPO_ID=justinforce/dotfiles
SSH_REPO=git@github.com:$REPO_ID
HTTPS_REPO=https://github.com/$REPO_ID
DEFAULT_RUBY=1.9.3

install_rvm() {

  # * autolibs will automatically install Ubuntu dependencies!
  # * ignore-dotfiles will avoid updating my dotfiles, which is unnecessary
  #   since I mange this configuration myself.
  #
  curl -L https://get.rvm.io | bash -s stable --autolibs=3 --ignore-dotfiles
}

reload_rvm() {
  for path in ~/.rvm/scripts/rvm /etc/profile.d/rvm.sh; do
    [ -e $path ] && source $path
  done
  rvm reload
}

install_ruby() {
  install_rvm
  reload_rvm
  rvm $DEFAULT_RUBY --install --default --autolibs=3
}

choose_repo() {
  if [ $ME = 'force' ]; then
    REPO=$SSH_REPO
  else
    REPO=$HTTPS_REPO
  fi
}

clone_or_update_repo() {
  if [ -e $DOTFILES ]; then
    cd $DOTFILES
    git pull origin master
    git submodule sync
    git submodule update --init
  else
    git clone --recursive $REPO $DOTFILES
  fi
}

run_rake_task() {
  cd $DOTFILES
  rake force
}

main() {
  echo -e "\e[1;32mReticulating splines...\e[m"
  install_ruby
  choose_repo
  clone_or_update_repo
  run_rake_task
}

main

:
