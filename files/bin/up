#!/bin/bash

set -ex

: "${_PLUG_SNAPSHOTS:="$HOME"/.config/nvim/PlugSnapshots}"

_EXT='PlugSnapshot'
_ISO_8601='%Y-%m-%dT%H:%M:%S%z'
_TIMESTAMP=$(date +"${_ISO_8601}")
# shellcheck disable=2012
_LATEST_SNAPSHOT=$(ls -t "${_PLUG_SNAPSHOTS}/"*.${_EXT} | head -n1)
_NEW_SNAPSHOT="${_PLUG_SNAPSHOTS}/${_TIMESTAMP}.${_EXT}"

sudo apt-get update -qq
sudo apt-get dist-upgrade -yqq

# XXX vim-polyglot breaks PlugUpdate, so clean it up first
(
  POLYGLOT=~/.config/nvim/plugged/vim-polyglot
  if [ -d "${POLYGLOT}" ]; then
  cd "${POLYGLOT}"
    git reset --hard
    git clean -df
  fi
)

# shellcheck disable=2016
nvim +'PlugUpgrade' \
     +'source $MYVIMRC' \
     +"PlugSnapshot! ${_NEW_SNAPSHOT}" \
     +'PlugUpdate' \
     +'PlugClean!' \
     +'qa'

# Remove the timestamp to compare it to the latest snapshot
# shellcheck disable=1117
sed -i "/.*\".*\b[0-9]\{4\}\b.*\b[0-9][0-9]:[0-9][0-9]/Id" "${_NEW_SNAPSHOT}"

if [ -n "${_LATEST_SNAPSHOT}" ]; then
  if diff "${_LATEST_SNAPSHOT}" "${_NEW_SNAPSHOT}"; then
    rm "${_NEW_SNAPSHOT}"
  fi
fi
