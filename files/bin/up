#!/bin/bash

set -ex

_NVIM_DIR="$HOME/.config/nvim"
_PLUG_SNAPSHOT="${_NVIM_DIR}/PlugSnapshot"
_POLYGLOT="${_NVIM_DIR}/plugged/vim-polyglot"
_DOTFILES="$HOME/src/dotfiles"

update-os() {
  if command -v apt-get; then
    sudo apt-get update -qq
    sudo apt-get dist-upgrade -yqq
  fi
}

update-dotfiles() {
  if [ -d "${_DOTFILES}" ]; then
    cd "${_DOTFILES}"
    rake
  fi
}

update-vscode-extensions() {
  if command -v vscs; then
    vscs
  fi
}

update-vim-plugins() {
  if command -v nvim; then
    # shellcheck disable=2012

    # XXX vim-polyglot breaks PlugUpdate, so just start clean
    rm -rf "${_POLYGLOT}"

    # shellcheck disable=2016
    nvim +'PlugUpgrade' \
        +'source $MYVIMRC' \
        +"PlugSnapshot! ${_PLUG_SNAPSHOT}" \
        +'PlugUpdate' \
        +'PlugClean!' \
        +'qa'

    # Remove the timestamp so it won't affect diffs
    # shellcheck disable=1117
    sed -i "/.*\".*\b[0-9]\{4\}\b.*\b[0-9][0-9]:[0-9][0-9]/Id" "${_PLUG_SNAPSHOT}"
  fi
}

update-os
update-dotfiles
update-vim-plugins
update-vscode-extensions
