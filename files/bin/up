#!/bin/bash -ex

_NVIM_DIR="$HOME/.config/nvim"
_PLUG_SNAPSHOT="${_NVIM_DIR}/PlugSnapshot"
_POLYGLOT="${_NVIM_DIR}/plugged/vim-polyglot"
_DOTFILES="$HOME/src/dotfiles"

update-os() {
  if command -v apt-get; then
    sudo apt-get update
    sudo apt-get dist-upgrade -y
  fi
}

update-dotfiles() {
  if [ -d "${_DOTFILES}" ]; then
    cd "${_DOTFILES}"
    rake
  fi
}

update-vscode-extensions() {
  if command -v vscs; then
    vscs
  fi
}

update-vim-plugins() {
  if command -v nvim; then
    # shellcheck disable=2012

    # XXX [vim-polyglot 1/2] breaks PlugUpdate, so we'll manage its clean up and
    # installation here instead of with vim-plug's { 'do': './build' }
    (
      cd "${_POLYGLOT}" &&
        git reset --hard &&
        git clean -d --force
    )

    # shellcheck disable=2016
    nvim +'PlugUpgrade' \
        +'source $MYVIMRC' \
        +'PlugClean!' \
        +'PlugUpdate' \
        +'source $MYVIMRC' \
        +"PlugSnapshot! ${_PLUG_SNAPSHOT}" \
        +'qa'

    # XXX [vim-polyglot 2/2] Build
    (
      cd "${_POLYGLOT}" &&
        ./build
    )

    # Remove the timestamp so it won't affect diffs
    # shellcheck disable=1117
    sed -i "/.*\".*\b[0-9]\{4\}\b.*\b[0-9][0-9]:[0-9][0-9]/Id" "${_PLUG_SNAPSHOT}"
  fi
}

update-os
update-dotfiles
update-vim-plugins

# Disabled in favor of Shan.code-settings-sync; remove if not needed
# https://marketplace.visualstudio.com/items?itemName=Shan.code-settings-sync
# update-vscode-extensions
