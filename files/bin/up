#!/bin/bash

set -ex


_ISO_8601='%Y-%m-%dT%H:%M:%S%z'
_NVIM_DIR="$HOME/.config/nvim"
_PLUG_SNAPSHOTS="${_NVIM_DIR}/PlugSnapshots"
_POLYGLOT="${_NVIM_DIR}/plugged/vim-polyglot"

update-os() {
  sudo apt-get update -qq
  sudo apt-get dist-upgrade -yqq
}

update-vscode-extensions() {
  vscs
}

update-vim-plugins() {
  local _ext _timestamp _latest_snapshot _new_snapshot
  _ext='PlugSnapshot'
  _timestamp=$(date +"${_ISO_8601}")
  # shellcheck disable=2012
  _latest_snapshot=$(ls -t "${_PLUG_SNAPSHOTS}/"*.${_ext} | head -n1)
  _new_snapshot="${_PLUG_SNAPSHOTS}/${_timestamp}.${_ext}"

  # XXX vim-polyglot breaks PlugUpdate, so just start clean
  rm -rf "${_POLYGLOT}"

  # shellcheck disable=2016
  nvim +'PlugUpgrade' \
       +'source $MYVIMRC' \
       +"PlugSnapshot! ${_new_snapshot}" \
       +'PlugUpdate' \
       +'PlugClean!' \
       +'qa'

  # Remove the timestamp to compare it to the latest snapshot
  # shellcheck disable=1117
  sed -i "/.*\".*\b[0-9]\{4\}\b.*\b[0-9][0-9]:[0-9][0-9]/Id" "${_new_snapshot}"

  if [ -n "${_latest_snapshot}" ]; then
    if diff "${_latest_snapshot}" "${_new_snapshot}"; then
      rm "${_new_snapshot}"
    fi
  fi
}

update-os
update-vim-plugins
update-vscode-extensions
