#!/bin/bash

readonly DATE_FORMAT="%Y%m%d%H%M%S"
readonly DATE_PATTERN='[0-9]\{14\}' # Match a date given in DATE_FORMAT

function _print_usage() {
  echo "Usage: $0 PATH_TO_MIGRATION_FILE"
}

function _old_version() {
  local migration_file_path
  migration_file_path="$1"
  grep -o "$DATE_PATTERN" <<< "$migration_file_path"
}

function _new_version() {
  date +"$DATE_FORMAT"
}

function _new_path() {
  local old_path new_version
  old_path="$1"
  new_version="$2"
  sed "s/$DATE_PATTERN/$new_version/" <<< "$old_path"
}

function _rename_migration_with_new_version() {
  local migration_file_path new_version new_path
  migration_file_path="$1"
  new_version="$2"
  new_path="$(_new_path "$migration_file_path" "$new_version")"
  (set -x; mv "$migration_file_path" "$new_path")
}

function _migrate() {
  local direction version
  direction="$1"
  version="$2"
  (set -x; rake db:migrate:"$direction" VERSION="$version")
}

if [ $# != 1 ]; then
  _print_usage
  exit 1
fi

function _main() {
  local migration_file_path old_version new_version
  migration_file_path="$1"
  old_version=$(_old_version "$migration_file_path")
  new_version=$(_new_version)
  _migrate down "$old_version"
  _rename_migration_with_new_version "$migration_file_path" "$new_version"
  _migrate up "$new_version"
}

_main "$1"
exit 0
