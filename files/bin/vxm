#!/bin/bash

if [ ! -z "$DEBUG" ]; then
  set -x
fi

OK=0
USAGE=1
SCRIPT_NAME="$(basename "$0")"
DEFAULT_LIST="$HOME/src/dotfiles/files/$SCRIPT_NAME.list"

LIST=${LIST:-$DEFAULT_LIST}

USAGE_TEXT="Usage: $SCRIPT_NAME [ACTION]

ACTIONS
  merge   - [default] upgrade then export
  install - install extensions listed in LIST
  upgrade - like install, but passes --force to upgrade installed extensions
  export  - write list of installed extensions to LIST

LIST
  The path to the list.
  Default LIST: $DEFAULT_LIST
  Current LIST: $LIST
  Override by setting LIST environment variable, e.g.

    LIST=my/list.txt $SCRIPT_NAME install
"

_install() {
  local code_args=( "$@" )
  while read -r extension; do
    yes 0 | code --install-extension "$extension" "${code_args[@]}"
  done < "$LIST"
}

_upgrade() {
  _install --force
}

_export() {
  code --list-extensions | tee "$LIST"
}

_print_usage_and_exit() {
  echo "$USAGE_TEXT"
  exit "$1"
}

case "$1" in
merge | '')
  _upgrade && _export
  ;;
install)
  _install
  ;;
upgrade)
  _upgrade
  ;;
export)
  _export
  ;;
-h | --help | help)
  _print_usage_and_exit $OK
  ;;
*)
  _print_usage_and_exit $USAGE
  ;;
esac

:
